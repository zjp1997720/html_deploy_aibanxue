<% 
// è®¾ç½®é¡µé¢æ•°æ®
const currentPath = '/admin/pages';
const title = 'é¡µé¢ç®¡ç†';
const breadcrumb = [
    { title: 'ç®¡ç†åå°', url: '/admin/dashboard' },
    { title: 'é¡µé¢ç®¡ç†' }
];
%>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - HTML-GO ç®¡ç†åå°</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="icon" href="/icon/web/favicon.ico">
</head>
<body class="admin-body">
    <div class="admin-layout">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="top-nav">
            <div class="nav-left">
                <div class="nav-brand">
                    <span class="brand-icon">ğŸš€</span>
                    <span class="brand-text">HTML-GO Admin</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <span class="toggle-icon">â˜°</span>
                </button>
            </div>
            <div class="nav-right">
                <div class="user-menu">
                    <span class="user-icon">ğŸ‘¤</span>
                    <span class="user-name">ç®¡ç†å‘˜</span>
                </div>
            </div>
        </nav>

        <!-- ä¾§è¾¹å¯¼èˆªæ  -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <nav class="sidebar-nav">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="/admin/dashboard" class="nav-link">
                                <span class="nav-icon">ğŸ“Š</span>
                                <span class="nav-text">æ¦‚è§ˆ</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/admin/pages" class="nav-link active">
                                <span class="nav-icon">ğŸ“„</span>
                                <span class="nav-text">é¡µé¢ç®¡ç†</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/admin/apikeys" class="nav-link">
                                <span class="nav-icon">ğŸ”‘</span>
                                <span class="nav-text">API Keyç®¡ç†</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/admin/settings" class="nav-link">
                                <span class="nav-icon">âš™ï¸</span>
                                <span class="nav-text">ç³»ç»Ÿè®¾ç½®</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <div class="sidebar-footer">
                    <a href="/" class="btn btn-sm btn-outline">ğŸŒ å‰å°</a>
                    <a href="/admin/pages/new" class="btn btn-sm btn-primary">â• æ–°å»º</a>
                </div>
            </div>
        </aside>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- é¢åŒ…å±‘å¯¼èˆª -->
            <div class="breadcrumb-container">
                <nav class="breadcrumb">
                    <a href="/admin/dashboard" class="breadcrumb-item">ç®¡ç†åå°</a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item current">é¡µé¢ç®¡ç†</span>
                </nav>
            </div>

            <!-- é¡µé¢å†…å®¹ -->
            <div class="page-content">
                <div class="page-header">
  <div class="page-header-content">
    <h1 class="page-title">
      <i class="fas fa-file-alt"></i>
      é¡µé¢ç®¡ç†
    </h1>
    <p class="page-description">
      ç®¡ç†æ‰€æœ‰å·²åˆ›å»ºçš„é¡µé¢ï¼Œæ”¯æŒæœç´¢ã€ç­›é€‰ã€ç¼–è¾‘å’Œæ‰¹é‡æ“ä½œ
    </p>
  </div>
  <div class="page-actions">
    <button class="btn btn-primary" onclick="window.open('/', '_blank')">
      <i class="fas fa-plus"></i>
      åˆ›å»ºæ–°é¡µé¢
    </button>
  </div>
</div>

<!-- ç»Ÿè®¡æ¦‚è§ˆ -->
<div class="stats-grid mb-6">
  <div class="stat-card">
    <div class="stat-icon bg-blue-100 text-blue-600">
      <i class="fas fa-file-alt"></i>
    </div>
    <div class="stat-content">
      <div class="stat-value" id="totalPages">--</div>
      <div class="stat-label">æ€»é¡µé¢æ•°</div>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-icon bg-green-100 text-green-600">
      <i class="fas fa-globe"></i>
    </div>
    <div class="stat-content">
      <div class="stat-value" id="publicPages">--</div>
      <div class="stat-label">å…¬å¼€é¡µé¢</div>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-icon bg-orange-100 text-orange-600">
      <i class="fas fa-lock"></i>
    </div>
    <div class="stat-content">
      <div class="stat-value" id="protectedPages">--</div>
      <div class="stat-label">å—ä¿æŠ¤é¡µé¢</div>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-icon bg-purple-100 text-purple-600">
      <i class="fas fa-calendar-day"></i>
    </div>
    <div class="stat-content">
      <div class="stat-value" id="todayPages">--</div>
      <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
    </div>
  </div>
</div>

<!-- æœç´¢å’Œç­›é€‰ -->
<div class="filter-section">
  <div class="filter-card">
    <div class="filter-header">
      <h3>æœç´¢å’Œç­›é€‰</h3>
      <button class="btn btn-sm btn-secondary" onclick="resetFilters()">
        <i class="fas fa-undo"></i>
        é‡ç½®
      </button>
    </div>
    
    <div class="filter-content">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">æœç´¢å…³é”®è¯</label>
          <input type="text" id="searchInput" class="form-input" 
                 placeholder="æœç´¢é¡µé¢åç§°æˆ–å†…å®¹..." onchange="applyFilters()">
        </div>
        
        <div class="filter-group">
          <label class="filter-label">å†…å®¹ç±»å‹</label>
          <select id="codeTypeFilter" class="form-select" onchange="applyFilters()">
            <option value="">å…¨éƒ¨ç±»å‹</option>
            <option value="html">HTML</option>
            <option value="markdown">Markdown</option>
            <option value="svg">SVG</option>
            <option value="mermaid">Mermaid</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">ä¿æŠ¤çŠ¶æ€</label>
          <select id="protectionFilter" class="form-select" onchange="applyFilters()">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="false">å…¬å¼€</option>
            <option value="true">å—ä¿æŠ¤</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">æ’åºæ–¹å¼</label>
          <select id="sortFilter" class="form-select" onchange="applyFilters()">
            <option value="created_at,DESC">åˆ›å»ºæ—¶é—´ï¼ˆæœ€æ–°ï¼‰</option>
            <option value="created_at,ASC">åˆ›å»ºæ—¶é—´ï¼ˆæœ€æ—©ï¼‰</option>
            <option value="name,ASC">åç§°ï¼ˆA-Zï¼‰</option>
            <option value="name,DESC">åç§°ï¼ˆZ-Aï¼‰</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- é¡µé¢åˆ—è¡¨ -->
<div class="data-card">
  <div class="data-card-header">
    <h2 class="data-card-title">
      <i class="fas fa-list"></i>
      é¡µé¢åˆ—è¡¨
      <span id="pageCount" class="page-count"></span>
    </h2>
    <div class="data-card-actions">
      <div class="batch-actions" id="batchActions" style="display: none;">
        <button class="btn btn-sm btn-danger" onclick="batchDelete()">
          <i class="fas fa-trash"></i>
          æ‰¹é‡åˆ é™¤
        </button>
        <button class="btn btn-sm btn-warning" onclick="batchProtect(true)">
          <i class="fas fa-lock"></i>
          è®¾ä¸ºä¿æŠ¤
        </button>
        <button class="btn btn-sm btn-success" onclick="batchProtect(false)">
          <i class="fas fa-unlock"></i>
          å–æ¶ˆä¿æŠ¤
        </button>
        <span class="selected-count" id="selectedCount">å·²é€‰æ‹© 0 é¡¹</span>
      </div>
      <button class="btn btn-sm btn-secondary" onclick="refreshPageList()">
        <i class="fas fa-sync-alt"></i>
        åˆ·æ–°
      </button>
    </div>
  </div>
  
  <div class="data-card-content">
    <div id="loadingSpinner" class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      åŠ è½½ä¸­...
    </div>
    
    <div id="pageListContainer" style="display: none;">
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
              </th>
              <th>é¡µé¢ä¿¡æ¯</th>
              <th>ç±»å‹</th>
              <th>çŠ¶æ€</th>
              <th>å†…å®¹å¤§å°</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="pageListBody">
            <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </tbody>
        </table>
      </div>
      
      <!-- åˆ†é¡µç»„ä»¶ -->
      <div id="paginationContainer" class="pagination-container">
        <!-- åˆ†é¡µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <div id="emptyState" class="empty-state" style="display: none;">
        <i class="fas fa-file-alt empty-icon"></i>
        <h3>æ²¡æœ‰æ‰¾åˆ°é¡µé¢</h3>
        <p>å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–åˆ›å»ºæ–°çš„é¡µé¢</p>
        <button class="btn btn-primary" onclick="window.open('/', '_blank')">
          <i class="fas fa-plus"></i>
          åˆ›å»ºæ–°é¡µé¢
        </button>
      </div>
    </div>
  </div>
</div>

<!-- é¡µé¢ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="editModal" class="modal">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="fas fa-edit"></i>
        ç¼–è¾‘é¡µé¢
      </h3>
      <button class="modal-close" onclick="hideEditModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form id="editPageForm">
        <input type="hidden" id="editPageId" name="pageId">
        
        <div class="form-group">
          <label for="editPageName" class="form-label">é¡µé¢åç§°</label>
          <input type="text" id="editPageName" name="name" class="form-input" 
                 placeholder="ç»™é¡µé¢èµ·ä¸€ä¸ªåç§°ï¼ˆå¯é€‰ï¼‰">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="editCodeType" class="form-label">å†…å®¹ç±»å‹</label>
            <select id="editCodeType" name="codeType" class="form-select">
              <option value="html">HTML</option>
              <option value="markdown">Markdown</option>
              <option value="svg">SVG</option>
              <option value="mermaid">Mermaid</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">ä¿æŠ¤è®¾ç½®</label>
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input type="checkbox" id="editIsProtected" name="isProtected">
                <span class="checkbox-mark"></span>
                å¯ç”¨å¯†ç ä¿æŠ¤
              </label>
            </div>
          </div>
        </div>
        
        <div class="form-group" id="editPasswordGroup" style="display: none;">
          <label for="editPassword" class="form-label">è®¿é—®å¯†ç </label>
          <input type="text" id="editPassword" name="password" class="form-input" 
                 placeholder="5ä½æ•°å­—å¯†ç " maxlength="5">
        </div>
        
        <div class="form-group">
          <label for="editHtmlContent" class="form-label">é¡µé¢å†…å®¹</label>
          <textarea id="editHtmlContent" name="htmlContent" class="form-textarea" 
                    rows="15" placeholder="åœ¨è¿™é‡Œè¾“å…¥æˆ–ç²˜è´´å†…å®¹..."></textarea>
          <small class="form-help">
            å†…å®¹å¤§å°: <span id="contentSize">0</span> å­—ç¬¦
          </small>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="hideEditModal()">å–æ¶ˆ</button>
      <button type="button" class="btn btn-primary" onclick="savePageChanges()">
        <i class="fas fa-save"></i>
        ä¿å­˜æ›´æ”¹
      </button>
    </div>
  </div>
</div>

<!-- é¡µé¢é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="previewModal" class="modal">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="fas fa-eye"></i>
        é¡µé¢é¢„è§ˆ
      </h3>
      <button class="modal-close" onclick="hidePreviewModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="preview-toolbar">
        <button class="btn btn-sm btn-primary" id="openPageBtn" onclick="openPageInNewTab()">
          <i class="fas fa-external-link-alt"></i>
          åœ¨æ–°çª—å£æ‰“å¼€
        </button>
        <button class="btn btn-sm btn-secondary" onclick="copyPageLink()">
          <i class="fas fa-copy"></i>
          å¤åˆ¶é“¾æ¥
        </button>
      </div>
      <div class="preview-container">
        <iframe id="previewFrame" class="preview-frame"></iframe>
      </div>
    </div>
  </div>
</div>

<script>
// é¡µé¢ç®¡ç†ç›¸å…³çš„JavaScriptä»£ç 
let currentPages = [];
let currentPagination = {};
let currentFilters = {
  page: 1,
  limit: 20,
  search: '',
  codeType: '',
  isProtected: null,
  sortBy: 'created_at',
  sortOrder: 'DESC'
};
let selectedPages = new Set();

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  loadPagesStats();
  loadPagesList();
  initEventListeners();
});

// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
function initEventListeners() {
  // æœç´¢è¾“å…¥æ¡†é˜²æŠ–
  let searchTimeout;
  document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      applyFilters();
    }, 500);
  });

  // ç¼–è¾‘é¡µé¢è¡¨å•ä¸­çš„å†…å®¹å¤§å°è®¡ç®—
  document.getElementById('editHtmlContent').addEventListener('input', function() {
    document.getElementById('contentSize').textContent = this.value.length;
  });

  // ä¿æŠ¤çŠ¶æ€å¤é€‰æ¡†å˜åŒ–
  document.getElementById('editIsProtected').addEventListener('change', function() {
    const passwordGroup = document.getElementById('editPasswordGroup');
    passwordGroup.style.display = this.checked ? 'block' : 'none';
  });
}

// åŠ è½½é¡µé¢ç»Ÿè®¡ä¿¡æ¯
async function loadPagesStats() {
  try {
    const response = await fetch('/api/admin/pages/stats');
    const data = await response.json();
    
    if (data.success) {
      const stats = data.stats;
      document.getElementById('totalPages').textContent = stats.total;
      document.getElementById('publicPages').textContent = stats.public;
      document.getElementById('protectedPages').textContent = stats.protected;
      document.getElementById('todayPages').textContent = stats.today;
    }
  } catch (error) {
    console.error('åŠ è½½é¡µé¢ç»Ÿè®¡é”™è¯¯:', error);
  }
}

// åŠ è½½é¡µé¢åˆ—è¡¨
async function loadPagesList() {
  try {
    const params = new URLSearchParams(currentFilters);
    const response = await fetch(`/api/admin/pages?${params}`);
    const data = await response.json();
    
    if (data.success) {
      currentPages = data.pages;
      currentPagination = data.pagination;
      renderPagesList();
      renderPagination();
      updatePageCount();
    } else {
      showNotification('åŠ è½½é¡µé¢åˆ—è¡¨å¤±è´¥: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('åŠ è½½é¡µé¢åˆ—è¡¨é”™è¯¯:', error);
    showNotification('åŠ è½½é¡µé¢åˆ—è¡¨å¤±è´¥', 'error');
  } finally {
    document.getElementById('loadingSpinner').style.display = 'none';
    document.getElementById('pageListContainer').style.display = 'block';
  }
}

// æ¸²æŸ“é¡µé¢åˆ—è¡¨
function renderPagesList() {
  const tbody = document.getElementById('pageListBody');
  const emptyState = document.getElementById('emptyState');
  
  if (currentPages.length === 0) {
    tbody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  tbody.innerHTML = currentPages.map(page => `
    <tr>
      <td>
        <input type="checkbox" class="page-checkbox" value="${page.id}" 
               onchange="togglePageSelection('${page.id}')">
      </td>
      <td>
        <div class="page-info">
          <div class="page-name">
            <strong>${escapeHtml(page.name || `HTML-${page.id}`)}</strong>
            <button class="btn-link" onclick="copyPageLink('${page.id}')" title="å¤åˆ¶é“¾æ¥">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <div class="page-id">ID: ${page.id}</div>
          ${page.name ? `<div class="page-content-preview">${escapeHtml(page.html_content.substring(0, 100))}...</div>` : ''}
        </div>
      </td>
      <td>
        <span class="type-badge type-${page.code_type}">${page.code_type.toUpperCase()}</span>
      </td>
      <td>
        <span class="status-badge ${page.is_protected ? 'status-protected' : 'status-public'}">
          <i class="fas ${page.is_protected ? 'fa-lock' : 'fa-globe'}"></i>
          ${page.is_protected ? 'å—ä¿æŠ¤' : 'å…¬å¼€'}
        </span>
      </td>
      <td>
        ${formatFileSize(page.content_size)}
      </td>
      <td>
        ${formatDate(page.created_at)}
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-sm btn-info" onclick="previewPage('${page.id}')" title="é¢„è§ˆ">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-secondary" onclick="editPage('${page.id}')" title="ç¼–è¾‘">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger" onclick="deletePage('${page.id}')" title="åˆ é™¤">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

// æ¸²æŸ“åˆ†é¡µç»„ä»¶
function renderPagination() {
  const container = document.getElementById('paginationContainer');
  const pagination = currentPagination;
  
  if (pagination.total <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let paginationHtml = '<div class="pagination">';
  
  // ä¸Šä¸€é¡µ
  if (pagination.hasPrev) {
    paginationHtml += `<button class="page-btn" onclick="goToPage(${pagination.current - 1})">
      <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
    </button>`;
  }
  
  // é¡µç æŒ‰é’®
  const startPage = Math.max(1, pagination.current - 2);
  const endPage = Math.min(pagination.total, pagination.current + 2);
  
  if (startPage > 1) {
    paginationHtml += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
    if (startPage > 2) {
      paginationHtml += '<span class="page-ellipsis">...</span>';
    }
  }
  
  for (let i = startPage; i <= endPage; i++) {
    paginationHtml += `<button class="page-btn ${i === pagination.current ? 'active' : ''}" 
                       onclick="goToPage(${i})">${i}</button>`;
  }
  
  if (endPage < pagination.total) {
    if (endPage < pagination.total - 1) {
      paginationHtml += '<span class="page-ellipsis">...</span>';
    }
    paginationHtml += `<button class="page-btn" onclick="goToPage(${pagination.total})">${pagination.total}</button>`;
  }
  
  // ä¸‹ä¸€é¡µ
  if (pagination.hasNext) {
    paginationHtml += `<button class="page-btn" onclick="goToPage(${pagination.current + 1})">
      ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
    </button>`;
  }
  
  paginationHtml += '</div>';
  
  // åˆ†é¡µä¿¡æ¯
  paginationHtml += `<div class="pagination-info">
    æ˜¾ç¤ºç¬¬ ${(pagination.current - 1) * pagination.limit + 1} - 
    ${Math.min(pagination.current * pagination.limit, pagination.totalRecords)} é¡¹ï¼Œ
    å…± ${pagination.totalRecords} é¡¹
  </div>`;
  
  container.innerHTML = paginationHtml;
}

// æ›´æ–°é¡µé¢è®¡æ•°
function updatePageCount() {
  const countElement = document.getElementById('pageCount');
  if (currentPagination.totalRecords > 0) {
    countElement.textContent = `(${currentPagination.totalRecords})`;
  } else {
    countElement.textContent = '';
  }
}

// åº”ç”¨ç­›é€‰æ¡ä»¶
function applyFilters() {
  const search = document.getElementById('searchInput').value.trim();
  const codeType = document.getElementById('codeTypeFilter').value;
  const isProtected = document.getElementById('protectionFilter').value;
  const [sortBy, sortOrder] = document.getElementById('sortFilter').value.split(',');
  
  currentFilters = {
    ...currentFilters,
    page: 1, // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
    search,
    codeType,
    isProtected: isProtected === '' ? null : isProtected,
    sortBy,
    sortOrder
  };
  
  selectedPages.clear();
  updateBatchActions();
  loadPagesList();
}

// é‡ç½®ç­›é€‰æ¡ä»¶
function resetFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('codeTypeFilter').value = '';
  document.getElementById('protectionFilter').value = '';
  document.getElementById('sortFilter').value = 'created_at,DESC';
  
  currentFilters = {
    page: 1,
    limit: 20,
    search: '',
    codeType: '',
    isProtected: null,
    sortBy: 'created_at',
    sortOrder: 'DESC'
  };
  
  selectedPages.clear();
  updateBatchActions();
  loadPagesList();
}

// è·³è½¬åˆ°æŒ‡å®šé¡µé¢
function goToPage(page) {
  currentFilters.page = page;
  loadPagesList();
}

// åˆ·æ–°é¡µé¢åˆ—è¡¨
function refreshPageList() {
  document.getElementById('loadingSpinner').style.display = 'block';
  document.getElementById('pageListContainer').style.display = 'none';
  loadPagesStats();
  loadPagesList();
}

// åˆ‡æ¢é¡µé¢é€‰æ‹©
function togglePageSelection(pageId) {
  const checkbox = document.querySelector(`input[value="${pageId}"]`);
  if (checkbox.checked) {
    selectedPages.add(pageId);
  } else {
    selectedPages.delete(pageId);
  }
  updateBatchActions();
}

// å…¨é€‰/å–æ¶ˆå…¨é€‰
function toggleSelectAll() {
  const selectAllCheckbox = document.getElementById('selectAll');
  const pageCheckboxes = document.querySelectorAll('.page-checkbox');
  
  pageCheckboxes.forEach(checkbox => {
    checkbox.checked = selectAllCheckbox.checked;
    if (selectAllCheckbox.checked) {
      selectedPages.add(checkbox.value);
    } else {
      selectedPages.delete(checkbox.value);
    }
  });
  
  updateBatchActions();
}

// æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®
function updateBatchActions() {
  const batchActions = document.getElementById('batchActions');
  const selectedCount = document.getElementById('selectedCount');
  
  if (selectedPages.size > 0) {
    batchActions.style.display = 'flex';
    selectedCount.textContent = `å·²é€‰æ‹© ${selectedPages.size} é¡¹`;
  } else {
    batchActions.style.display = 'none';
  }
}

// é¢„è§ˆé¡µé¢
function previewPage(pageId) {
  const page = currentPages.find(p => p.id === pageId);
  if (!page) return;
  
  const modal = document.getElementById('previewModal');
  const frame = document.getElementById('previewFrame');
  const openBtn = document.getElementById('openPageBtn');
  
  const url = `/view/${pageId}`;
  frame.src = url;
  openBtn.onclick = () => window.open(url, '_blank');
  
  modal.style.display = 'flex';
}

// éšè—é¢„è§ˆæ¨¡æ€æ¡†
function hidePreviewModal() {
  document.getElementById('previewModal').style.display = 'none';
  document.getElementById('previewFrame').src = '';
}

// ç¼–è¾‘é¡µé¢
function editPage(pageId) {
  const page = currentPages.find(p => p.id === pageId);
  if (!page) return;
  
  // å¡«å……è¡¨å•
  document.getElementById('editPageId').value = page.id;
  document.getElementById('editPageName').value = page.name || '';
  document.getElementById('editCodeType').value = page.code_type || 'html';
  document.getElementById('editIsProtected').checked = page.is_protected === 1;
  document.getElementById('editPassword').value = page.password || '';
  document.getElementById('editHtmlContent').value = page.html_content || '';
  
  // æ˜¾ç¤º/éšè—å¯†ç å­—æ®µ
  const passwordGroup = document.getElementById('editPasswordGroup');
  passwordGroup.style.display = page.is_protected === 1 ? 'block' : 'none';
  
  // æ›´æ–°å†…å®¹å¤§å°
  document.getElementById('contentSize').textContent = (page.html_content || '').length;
  
  document.getElementById('editModal').style.display = 'flex';
}

// éšè—ç¼–è¾‘æ¨¡æ€æ¡†
function hideEditModal() {
  document.getElementById('editModal').style.display = 'none';
  document.getElementById('editPageForm').reset();
}

// ä¿å­˜é¡µé¢æ›´æ”¹
async function savePageChanges() {
  const form = document.getElementById('editPageForm');
  const formData = new FormData(form);
  
  const pageId = formData.get('pageId');
  const updates = {
    name: formData.get('name'),
    codeType: formData.get('codeType'),
    isProtected: document.getElementById('editIsProtected').checked,
    password: formData.get('password'),
    htmlContent: formData.get('htmlContent')
  };
  
  try {
    const response = await fetch(`/api/admin/pages/${pageId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updates)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification('é¡µé¢æ›´æ–°æˆåŠŸ', 'success');
      hideEditModal();
      refreshPageList();
    } else {
      showNotification('æ›´æ–°å¤±è´¥: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('ä¿å­˜é¡µé¢æ›´æ”¹é”™è¯¯:', error);
    showNotification('ä¿å­˜å¤±è´¥', 'error');
  }
}

// åˆ é™¤å•ä¸ªé¡µé¢
async function deletePage(pageId) {
  const page = currentPages.find(p => p.id === pageId);
  const pageName = page ? (page.name || `HTML-${page.id}`) : pageId;
  
  if (!confirm(`ç¡®å®šè¦åˆ é™¤é¡µé¢"${pageName}"å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
    return;
  }
  
  try {
    const response = await fetch(`/api/admin/pages/${pageId}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification('é¡µé¢åˆ é™¤æˆåŠŸ', 'success');
      refreshPageList();
    } else {
      showNotification('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('åˆ é™¤é¡µé¢é”™è¯¯:', error);
    showNotification('åˆ é™¤å¤±è´¥', 'error');
  }
}

// æ‰¹é‡åˆ é™¤é¡µé¢
async function batchDelete() {
  if (selectedPages.size === 0) {
    showNotification('è¯·é€‰æ‹©è¦åˆ é™¤çš„é¡µé¢', 'warning');
    return;
  }
  
  if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedPages.size} ä¸ªé¡µé¢å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
    return;
  }
  
  try {
    const response = await fetch('/api/admin/pages/batch/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        pageIds: Array.from(selectedPages)
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification(data.message, 'success');
      selectedPages.clear();
      updateBatchActions();
      refreshPageList();
    } else {
      showNotification('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + data.error, 'error');
    }
  } catch (error) {
    console.error('æ‰¹é‡åˆ é™¤é”™è¯¯:', error);
    showNotification('æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
  }
}

// æ‰¹é‡è®¾ç½®ä¿æŠ¤çŠ¶æ€
async function batchProtect(isProtected) {
  if (selectedPages.size === 0) {
    showNotification('è¯·é€‰æ‹©è¦æ“ä½œçš„é¡µé¢', 'warning');
    return;
  }
  
  const action = isProtected ? 'è®¾ä¸ºä¿æŠ¤' : 'å–æ¶ˆä¿æŠ¤';
  if (!confirm(`ç¡®å®šè¦${action}é€‰ä¸­çš„ ${selectedPages.size} ä¸ªé¡µé¢å—ï¼Ÿ`)) {
    return;
  }
  
  try {
    const response = await fetch('/api/admin/pages/batch/protection', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        pageIds: Array.from(selectedPages),
        isProtected
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification(data.message, 'success');
      selectedPages.clear();
      updateBatchActions();
      refreshPageList();
    } else {
      showNotification(`æ‰¹é‡${action}å¤±è´¥: ` + data.error, 'error');
    }
  } catch (error) {
    console.error(`æ‰¹é‡${action}é”™è¯¯:`, error);
    showNotification(`æ‰¹é‡${action}å¤±è´¥`, 'error');
  }
}

// å¤åˆ¶é¡µé¢é“¾æ¥
function copyPageLink(pageId) {
  const url = `${window.location.origin}/view/${pageId}`;
  navigator.clipboard.writeText(url).then(() => {
    showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
  }).catch(() => {
    // é™çº§æ–¹æ¡ˆ
    const input = document.createElement('input');
    input.value = url;
    document.body.appendChild(input);
    input.select();
    document.execCommand('copy');
    document.body.removeChild(input);
    showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
  });
}

// åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é¡µé¢
let currentPreviewPageId = null;
function openPageInNewTab() {
  if (currentPreviewPageId) {
    window.open(`/view/${currentPreviewPageId}`, '_blank');
  }
}

// å·¥å…·å‡½æ•°
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatDate(timestamp) {
  const date = new Date(parseInt(timestamp));
  return date.toLocaleString('zh-CN');
}

function formatFileSize(size) {
  if (size < 1024) return size + ' B';
  if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB';
  return (size / (1024 * 1024)).toFixed(1) + ' MB';
}

// æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.style.display = 'none';
  }
});
</script>

<style>
/* é¡µé¢ç®¡ç†ä¸“ç”¨æ ·å¼ */
.filter-section {
  margin-bottom: 2rem;
}

.filter-card {
  background: white;
  border-radius: 8px;
  box-shadow: var(--admin-shadow);
  overflow: hidden;
}

.filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--admin-border);
  background: #f8fafc;
}

.filter-header h3 {
  margin: 0;
  color: var(--admin-dark);
  font-size: 1rem;
}

.filter-content {
  padding: 1.5rem;
}

.filter-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr;
  gap: 1rem;
  align-items: end;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.filter-label {
  font-weight: 500;
  color: var(--admin-secondary);
  font-size: 0.875rem;
}

.page-info {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.page-name {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.page-id {
  font-size: 0.75rem;
  color: var(--admin-secondary);
  font-family: monospace;
}

.page-content-preview {
  font-size: 0.75rem;
  color: #6b7280;
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.type-badge {
  padding: 0.125rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  font-weight: 500;
  text-transform: uppercase;
}

.type-html { background: #dbeafe; color: #1e40af; }
.type-markdown { background: #d1fae5; color: #065f46; }
.type-svg { background: #fef3c7; color: #92400e; }
.type-mermaid { background: #e0e7ff; color: #5b21b6; }

.status-badge {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  font-weight: 500;
}

.status-public { background: #d1fae5; color: #065f46; }
.status-protected { background: #fef3c7; color: #92400e; }

.action-buttons {
  display: flex;
  gap: 0.25rem;
}

.batch-actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  background: #f1f5f9;
  border-radius: 6px;
}

.selected-count {
  font-size: 0.875rem;
  color: var(--admin-secondary);
  margin-left: 0.5rem;
}

.pagination-container {
  margin-top: 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.pagination {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.page-btn {
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--admin-border);
  background: white;
  color: var(--admin-secondary);
  border-radius: 6px;
  cursor: pointer;
  transition: var(--admin-transition);
  font-size: 0.875rem;
}

.page-btn:hover {
  background: var(--admin-light);
  border-color: var(--admin-primary);
}

.page-btn.active {
  background: var(--admin-primary);
  color: white;
  border-color: var(--admin-primary);
}

.page-ellipsis {
  padding: 0.5rem;
  color: var(--admin-secondary);
}

.pagination-info {
  font-size: 0.875rem;
  color: var(--admin-secondary);
}

.preview-toolbar {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.preview-container {
  border: 1px solid var(--admin-border);
  border-radius: 6px;
  overflow: hidden;
  background: white;
}

.preview-frame {
  width: 100%;
  height: 600px;
  border: none;
  background: white;
}

.page-count {
  color: var(--admin-secondary);
  font-weight: normal;
  font-size: 0.875rem;
}

.btn-link {
  background: none;
  border: none;
  color: var(--admin-secondary);
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  transition: var(--admin-transition);
}

.btn-link:hover {
  color: var(--admin-primary);
  background: var(--admin-light);
}

.form-textarea {
  resize: vertical;
  min-height: 300px;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 0.875rem;
}

@media (max-width: 768px) {
  .filter-row {
    grid-template-columns: 1fr;
  }
  
  .batch-actions {
    flex-direction: column;
    align-items: stretch;
  }
  
  .pagination-container {
    flex-direction: column;
    text-align: center;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .page-info {
    min-width: 200px;
  }
}</style>

            </div>
        </main>
    </div>

    <!-- ç§»åŠ¨ç«¯é®ç½© -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- è„šæœ¬æ–‡ä»¶ -->
    <script src="/js/admin-common.js"></script>
</body>
</html> 